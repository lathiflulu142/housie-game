<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Housie - Host</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div>
            <h1>üé§ Housie</h1>
            <div class="room-badge">Room: <span id="room-code-display">----</span></div>
        </div>
        <div class="header-actions">
            <select id="theme-selector" onchange="changeTheme()" class="theme-btn">
                <option value="default">üåû</option>
                <option value="theme-dark">üåô</option>
            </select>
            <button onclick="openInviteModal()">üì≤ Invite</button>
            <button onclick="openModal()">üî¢ Board</button>
            <button onclick="openResetModal()">üîÑ Reset</button>
        </div>
    </header>

    <main>
        <div class="draw-section">
            <div id="current-number">Go!</div>
            <button id="draw-btn" onclick="drawNumber()">Draw Number</button>
        </div>

        <div class="leaderboard" id="leaderboard-box" style="display: none;">
            <h3>üèÜ Live Winners</h3>
            <ul id="winners-list"></ul>
        </div>

        <div class="ticket-container">
            <div class="host-ticket-header">
                <h2>My Tickets</h2>
                <select id="ticket-count-input" onchange="changeHostTickets()">
                    <option value="1">1 Ticket</option>
                    <option value="2">2 Tickets</option>
                    <option value="3">3 Tickets</option>
                </select>
            </div>
            <div id="host-ticket-container"></div>
        </div>

        <div class="claims-container" id="claims-box">
            <button id="btn-jaldi" class="claim-btn" onclick="claimPrize('jaldi', 'Jaldi 5', this)">Jaldi 5</button>
            <button id="btn-top" class="claim-btn disabled" disabled onclick="claimPrize('top', 'Top Line', this)">Top Line</button>
            <button id="btn-mid" class="claim-btn disabled" disabled onclick="claimPrize('mid', 'Middle Line', this)">Mid Line</button>
            <button id="btn-bot" class="claim-btn disabled" disabled onclick="claimPrize('bot', 'Bottom Line', this)">Bot Line</button>
            <button id="btn-full" class="claim-btn full-house disabled" disabled onclick="claimPrize('full', 'Full House', this)">üéâ FULL HOUSE üéâ</button>
        </div>

        <div class="host-player-list">
            <h2>Live Players: <span id="player-count-display">0</span></h2>
            <ul id="active-players"></ul>
        </div>
    </main>

    <div id="board-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>Called Numbers</h2>
            <div id="missed-msg" style="color: #ff0844; font-weight: bold; margin-bottom: 10px; display: none; background: #ffe6e6; padding: 10px; border-radius: 8px;"></div>
            <div id="full-board" class="board-grid"></div>
        </div>
    </div>

    <div id="invite-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeInviteModal()">&times;</span><h2>Invite Players</h2><p>Scan to auto-join:</p><div id="invite-code-display" style="font-size:28px; color:#ff0844; font-weight:bold; letter-spacing:3px;">----</div><img id="qr-code-img" src="" alt="QR Code" width="180" style="margin-top:15px; border-radius:15px;"><div style="margin-top:20px;"><button style="background:#25D366; color:white; border:none; padding:15px; border-radius:10px; font-weight:bold; font-size:16px; width:100%; cursor:pointer;" onclick="executeShare()">üí¨ Share Link</button></div></div></div>
    <div id="reset-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeResetModal()">&times;</span><h2>Game Options</h2><div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;"><button style="background:#6e8efb; color:white; border:none; padding:15px; border-radius:10px; font-weight:bold; font-size:16px; cursor:pointer;" onclick="resetGame()">üîÑ Next Round (Keep Players)</button><button style="background:#ff4757; color:white; border:none; padding:15px; border-radius:10px; font-weight:bold; font-size:16px; cursor:pointer;" onclick="destroyRoom()">üõë End Party (Kick All)</button></div></div></div>
    <div id="celebration-popup"></div>

    <audio id="sound-pop" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" preload="auto"></audio>
    <audio id="sound-win" src="https://actions.google.com/sounds/v1/crowds/party_horn.ogg" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // ==========================================
        // üö® PASTE YOUR REAL FIREBASE KEYS HERE üö®
        // ==========================================
        const firebaseConfig = {
    apiKey: "AIzaSyBaQyf99P3TEp34hhvPZqqPeQ9VCLSQ3N0",
    authDomain: "housieapp-3dc3e.firebaseapp.com",
    databaseURL: "https://housieapp-3dc3e-default-rtdb.firebaseio.com",
    projectId: "housieapp-3dc3e",
    storageBucket: "housieapp-3dc3e.firebasestorage.app",
    messagingSenderId: "709288045803",
    appId: "1:709288045803:web:6505478d4588fec2aae2ae",
    measurementId: "G-6SBEGQB7BE"
  };
        // ==========================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const myPlayerName = "Host üé§";
        const currentNumberDisplay = document.getElementById('current-number');

        let savedTheme = localStorage.getItem('housie_theme') || 'default';
        function applyTheme(theme) { document.body.className = (theme === 'default') ? '' : theme; document.getElementById('theme-selector').value = theme; }
        function changeTheme() { let selected = document.getElementById('theme-selector').value; localStorage.setItem('housie_theme', selected); applyTheme(selected); }
        applyTheme(savedTheme);

        let hostState = JSON.parse(localStorage.getItem('housie_host'));
        function generateRoomCode() { let code = ''; for (let i = 0; i < 4; i++) code += '0123456789'.charAt(Math.floor(Math.random() * 10)); return code; }

        const myRoomCode = hostState ? hostState.myRoomCode : generateRoomCode();
        let numberBag = hostState ? hostState.numberBag : Array.from({length: 90}, (_, i) => i + 1);
        let myTicketNumbers = hostState ? hostState.myTicketNumbers : null;
        let myMarkedNumbers = hostState ? hostState.myMarkedNumbers : [];
        let currentDrawn = hostState ? hostState.currentDrawn : "Go!";
        let ticketCount = hostState ? (hostState.ticketCount || 1) : 1;

        document.getElementById('room-code-display').innerText = myRoomCode;
        document.getElementById('ticket-count-input').value = ticketCount;
        currentNumberDisplay.innerText = currentDrawn;
        if(currentDrawn !== "Go!") currentNumberDisplay.style.fontSize = "60px";

        function saveHost() { localStorage.setItem('housie_host', JSON.stringify({ myRoomCode, numberBag, myTicketNumbers, myMarkedNumbers, currentDrawn, ticketCount })); }

        const roomRef = db.ref('rooms/' + myRoomCode);
        if (!hostState) {
            roomRef.child('latestNumber').set("Ready"); roomRef.child('resetTrigger').set(Date.now());
            roomRef.child('isRolling').set(false);
            roomRef.child('claims').remove(); roomRef.child('calledNumbers').remove(); saveHost();
        }

        let rollInterval;
        roomRef.child('isRolling').on('value', (snapshot) => {
            if(snapshot.val()) {
                currentNumberDisplay.classList.add('rolling-text');
                document.getElementById('sound-pop').play().catch(()=>{});
                rollInterval = setInterval(() => {
                    currentNumberDisplay.innerText = Math.floor(Math.random() * 90) + 1;
                }, 50);
            } else {
                clearInterval(rollInterval);
                currentNumberDisplay.classList.remove('rolling-text');
            }
        });

        function shootConfetti() {
            for(let i=0; i<80; i++) {
                let conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.animationDuration = (Math.random() * 2 + 2) + 's';
                conf.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), 4000);
            }
        }

        function changeHostTickets() {
            if (currentDrawn !== "Go!") { alert("Cannot change tickets after drawing numbers!"); document.getElementById('ticket-count-input').value = ticketCount; return; }
            ticketCount = parseInt(document.getElementById('ticket-count-input').value); myTicketNumbers = null; myMarkedNumbers = []; generateHostTicket();
        }

        const boardModal = document.getElementById('board-modal'); const inviteModal = document.getElementById('invite-modal'); const resetModal = document.getElementById('reset-modal');
        function openModal() { 
            let missed = [];
            if (myTicketNumbers) {
                for (let t = 0; t < myTicketNumbers.length; t++) {
                    for (let row = 0; row < 3; row++) {
                        for (let col = 0; col < 9; col++) {
                            let num = myTicketNumbers[t][row][col];
                            if (num !== null) {
                                let cell = document.getElementById(`board-num-${num}`);
                                if (cell && cell.classList.contains('called') && !myMarkedNumbers.includes(num)) {
                                    if(!missed.includes(num)) missed.push(num);
                                }
                            }
                        }
                    }
                }
            }
            const missedMsg = document.getElementById('missed-msg');
            if (missed.length > 0) { missedMsg.innerHTML = `‚ö†Ô∏è <b>You missed marking:</b> ${missed.join(', ')}`; missedMsg.style.display = "block"; } else { missedMsg.style.display = "none"; }
            boardModal.style.display = "flex"; 
        } 
        function closeModal() { boardModal.style.display = "none"; }
        function openResetModal() { resetModal.style.display = "flex"; } function closeResetModal() { resetModal.style.display = "none"; }
        function openInviteModal() {
            const magicLink = window.location.href.replace("host.html", "player.html") + "?room=" + myRoomCode;
            document.getElementById('invite-code-display').innerText = myRoomCode;
            document.getElementById('qr-code-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(magicLink)}`;
            inviteModal.style.display = "flex";
        }
        function closeInviteModal() { inviteModal.style.display = "none"; }
        function executeShare() {
            const magicLink = window.location.href.replace("host.html", "player.html") + "?room=" + myRoomCode;
            const text = `üéâ Join my Housie Party! \nRoom Code: *${myRoomCode}*\nClick here to play: ${magicLink}`;
            if (navigator.share) navigator.share({ title: 'Housie Party', text: text }); else navigator.clipboard.writeText(text);
        }
        window.onclick = function(event) { if (event.target == boardModal) closeModal(); if (event.target == inviteModal) closeInviteModal(); if (event.target == resetModal) closeResetModal(); }

        // --- UPDATED: DISPLAY PLAYER NAME & TICKET COUNT ---
        roomRef.child('players').on('value', (snapshot) => {
            const players = snapshot.val() || {};
            document.getElementById('player-count-display').innerText = Object.keys(players).length;
            const playerList = document.getElementById('active-players'); playerList.innerHTML = ''; 
            for (let playerId in players) {
                let li = document.createElement('li'); li.className = 'player-item';
                let pName = players[playerId].name || "Unknown";
                let pTix = players[playerId].tickets || 1;
                li.innerHTML = `
                    <span>
                        üë§ <b>${pName}</b> 
                        <small style="color: #6e8efb; font-weight: 900; margin-left: 8px;">(${pTix} üéüÔ∏è)</small>
                    </span> 
                    <button class="kick-btn" onclick="kickPlayer('${playerId}')">Kick</button>
                `;
                playerList.appendChild(li);
            }
        });

        function kickPlayer(playerId) { if(confirm("Remove player?")) roomRef.child('players/' + playerId).remove(); }

        roomRef.child('calledNumbers').on('value', (snapshot) => {
            const called = snapshot.val() || {}; document.querySelectorAll('.board-cell').forEach(c => c.classList.remove('called'));
            for(let num in called) { let cell = document.getElementById(`board-num-${num}`); if(cell) cell.classList.add('called'); }
        });

        roomRef.child('claims').on('value', (snapshot) => {
            const claims = snapshot.val() || {}; 
            const leaderboard = document.getElementById('winners-list'); const leaderboardBox = document.getElementById('leaderboard-box');
            leaderboard.innerHTML = ''; let hasWinners = false;

            let hasJaldi = !!claims['jaldi'];
            let hasTop = !!claims['top']; let hasMid = !!claims['mid']; let hasBot = !!claims['bot'];
            let allLines = hasTop && hasMid && hasBot;
            let isFull = !!claims['full'];

            const btnJaldi = document.getElementById('btn-jaldi');
            if(btnJaldi) btnJaldi.style.display = hasJaldi ? 'none' : 'inline-block';

            ['top', 'mid', 'bot'].forEach(line => {
                let btn = document.getElementById('btn-' + line);
                if(btn) {
                    if(claims[line]) { btn.style.display = 'none'; } 
                    else {
                        btn.style.display = 'inline-block';
                        if(hasJaldi) { btn.disabled = false; btn.classList.remove('disabled'); } 
                        else { btn.disabled = true; btn.classList.add('disabled'); }
                    }
                }
            });

            let fullBtn = document.getElementById('btn-full');
            if (fullBtn) {
                if(isFull) {
                    fullBtn.style.display = 'none';
                    shootConfetti(); 
                    document.getElementById('draw-btn').disabled = true;
                    document.getElementById('draw-btn').innerText = "Game Over! üéâ";
                    document.getElementById('draw-btn').classList.add('disabled');
                } else {
                    fullBtn.style.display = 'inline-block';
                    if (allLines) { fullBtn.disabled = false; fullBtn.classList.remove('disabled'); } 
                    else { fullBtn.disabled = true; fullBtn.classList.add('disabled'); }
                }
            }

            for(let prizeId in claims) {
                hasWinners = true;
                if(!window.knownClaims) window.knownClaims = {};
                if(!window.knownClaims[prizeId]) { 
                    document.getElementById('sound-win').play().catch(()=>{}); 
                    window.knownClaims[prizeId] = true; 
                    const popup = document.getElementById('celebration-popup');
                    popup.innerText = `üéâ ${claims[prizeId].winner} won ${claims[prizeId].prizeName}! üéâ`; 
                    popup.classList.add('show'); setTimeout(() => popup.classList.remove('show'), 4000); 
                }
                let li = document.createElement('li'); li.innerHTML = `<span>üéä ${claims[prizeId].prizeName}</span> <span class="winner-name">${claims[prizeId].winner}</span>`; leaderboard.appendChild(li);
            }
            leaderboardBox.style.display = hasWinners ? "block" : "none";
        });

        function claimPrize(prizeId, prizeName, btnElement) {
            let isValid = false;
            for (let t = 0; t < myTicketNumbers.length; t++) {
                const ticketDiv = document.getElementById(`ticket-grid-${t}`); const markedCells = ticketDiv.querySelectorAll('.cell.marked');
                if(prizeId === 'jaldi' && markedCells.length >= 5) isValid = true;
                if(prizeId === 'top' && ticketDiv.querySelectorAll('.cell.row-0.marked').length === 5) isValid = true;
                if(prizeId === 'mid' && ticketDiv.querySelectorAll('.cell.row-1.marked').length === 5) isValid = true;
                if(prizeId === 'bot' && ticketDiv.querySelectorAll('.cell.row-2.marked').length === 5) isValid = true;
                if(prizeId === 'full' && markedCells.length === 15) isValid = true;
                if (isValid) break;
            }
            if(!isValid) { btnElement.classList.add('error-shake'); setTimeout(() => btnElement.classList.remove('error-shake'), 300); return; }
            roomRef.child('claims/' + prizeId).set({ winner: myPlayerName, prizeName: prizeName }); 
        }

        function drawNumber() {
            let drawBtn = document.getElementById('draw-btn');
            if (numberBag.length === 0 || drawBtn.disabled) return;
            drawBtn.disabled = true; 

            const drawnNum = numberBag.splice(Math.floor(Math.random() * numberBag.length), 1)[0];
            roomRef.child('isRolling').set(true); 

            setTimeout(() => {
                roomRef.child('isRolling').set(false);
                roomRef.child('latestNumber').set(drawnNum); 
                roomRef.child('calledNumbers/' + drawnNum).set(true); 
                currentDrawn = drawnNum; currentNumberDisplay.innerText = drawnNum; currentNumberDisplay.style.fontSize = "60px";
                saveHost();
                drawBtn.disabled = false; 
            }, 1500); 
        }

        function resetGame() {
            if (!confirm("Start next round with the same Room Code?")) return; 
            numberBag = Array.from({length: 90}, (_, i) => i + 1); myTicketNumbers = null; myMarkedNumbers = [];
            currentDrawn = "Go!"; currentNumberDisplay.innerText = "Go!"; ticketCount = parseInt(document.getElementById('ticket-count-input').value);
            document.querySelectorAll('.board-cell').forEach(cell => cell.classList.remove('called')); 
            document.getElementById('draw-btn').disabled = false; document.getElementById('draw-btn').innerText = "Draw Number"; document.getElementById('draw-btn').classList.remove('disabled');
            window.knownClaims = {}; generateHostTicket();
            roomRef.child('resetTrigger').set(Date.now()); roomRef.child('latestNumber').set("Ready"); roomRef.child('calledNumbers').remove(); roomRef.child('claims').remove(); 
            closeResetModal();
        }

        function destroyRoom() { if (!confirm("WARNING: Kicks all players. Proceed?")) return; roomRef.remove(); localStorage.removeItem('housie_host'); window.location.reload(); }

        function setupFullBoard() { const fullBoard = document.getElementById('full-board'); if (!fullBoard) return; fullBoard.innerHTML = ''; for (let i = 1; i <= 90; i++) { const cell = document.createElement('div'); cell.classList.add('board-cell'); cell.id = `board-num-${i}`; cell.innerText = i; fullBoard.appendChild(cell); } }

        function highlightMyNumbersOnBoard() {
            if (!myTicketNumbers) return; let myNums = new Set();
            for (let t = 0; t < myTicketNumbers.length; t++) { for (let row = 0; row < 3; row++) { for (let col = 0; col < 9; col++) { if (myTicketNumbers[t][row][col] !== null) myNums.add(myTicketNumbers[t][row][col]); } } }
            for (let i = 1; i <= 90; i++) { let cell = document.getElementById(`board-num-${i}`); if (cell) { if (myNums.has(i)) cell.classList.add('my-number'); else cell.classList.remove('my-number'); } }
        }

        function generateHostTicket() {
            const container = document.getElementById('host-ticket-container'); if (!container) return; container.innerHTML = ''; 
            if (!myTicketNumbers) {
                myTicketNumbers = [];
                const ticketLayouts = [ [ [1, 0, 1, 1, 0, 1, 0, 1, 0], [0, 1, 0, 1, 0, 1, 0, 1, 1], [1, 0, 1, 0, 1, 0, 1, 0, 1] ], [ [1, 0, 1, 0, 1, 1, 0, 1, 0], [1, 0, 1, 1, 0, 0, 1, 0, 1], [0, 1, 0, 1, 1, 0, 0, 1, 1] ], [ [0, 1, 1, 0, 1, 0, 1, 0, 1], [1, 1, 0, 1, 0, 1, 0, 1, 0], [0, 1, 0, 1, 1, 0, 1, 0, 1] ], [ [0, 1, 0, 1, 1, 0, 1, 0, 1], [1, 1, 0, 1, 0, 1, 0, 1, 0], [0, 1, 1, 0, 1, 0, 1, 1, 0] ], [ [1, 0, 1, 0, 1, 1, 0, 1, 0], [1, 0, 1, 0, 1, 0, 1, 0, 1], [0, 1, 0, 1, 1, 0, 1, 1, 0] ] ];
                const colRanges = [[1, 9], [10, 19], [20, 29], [30, 39], [40, 49], [50, 59], [60, 69], [70, 79], [80, 90]];
                let masterPool = []; for (let c = 0; c < 9; c++) { let colNums = []; for (let i = colRanges[c][0]; i <= colRanges[c][1]; i++) colNums.push(i); masterPool.push(colNums); }

                for (let t = 0; t < ticketCount; t++) {
                    let singleTicket = [[], [], []]; const ticketPattern = ticketLayouts[Math.floor(Math.random() * ticketLayouts.length)];
                    for (let col = 0; col < 9; col++) {
                        let numbersNeeded = (ticketPattern[0][col] + ticketPattern[1][col] + ticketPattern[2][col]); let selectedForCol = [];
                        for (let n = 0; n < numbersNeeded; n++) {
                            if (masterPool[col].length === 0) { for (let i = colRanges[col][0]; i <= colRanges[col][1]; i++) masterPool[col].push(i); }
                            let randIdx = Math.floor(Math.random() * masterPool[col].length); selectedForCol.push(masterPool[col].splice(randIdx, 1)[0]);
                        }
                        selectedForCol.sort((a, b) => a - b); let numIndex = 0;
                        for (let row = 0; row < 3; row++) singleTicket[row][col] = (ticketPattern[row][col] === 1) ? selectedForCol[numIndex++] : null;
                    }
                    myTicketNumbers.push(singleTicket);
                }
                saveHost();
            }

            for (let t = 0; t < myTicketNumbers.length; t++) {
                const ticketDiv = document.createElement('div'); ticketDiv.className = 'ticket-grid'; ticketDiv.id = `ticket-grid-${t}`; let ticketData = myTicketNumbers[t];
                for (let row = 0; row < 3; row++) {
                    for (let col = 0; col < 9; col++) {
                        const cell = document.createElement('div'); cell.classList.add('cell'); cell.classList.add(`row-${row}`); let cellVal = ticketData[row][col];
                        if (cellVal !== null) {
                            cell.innerText = cellVal; if (myMarkedNumbers.includes(cellVal)) cell.classList.add('marked');
                            cell.addEventListener('click', function() { 
                                if(document.getElementById(`board-num-${cellVal}`).classList.contains('called')) {
                                    this.classList.remove('blink-active'); this.classList.toggle('marked'); 
                                    if(this.classList.contains('marked')) { if(!myMarkedNumbers.includes(cellVal)) myMarkedNumbers.push(cellVal); } else { myMarkedNumbers = myMarkedNumbers.filter(n => n !== cellVal); }
                                    saveHost();
                                    document.querySelectorAll('#host-ticket-container .cell').forEach(c => { if(parseInt(c.innerText) === cellVal) { c.classList.remove('blink-active'); if(myMarkedNumbers.includes(cellVal)) c.classList.add('marked'); else c.classList.remove('marked'); } });
                                } else {
                                    this.classList.add('error-shake'); setTimeout(() => this.classList.remove('error-shake'), 300);
                                }
                            });
                        } else { cell.classList.add('empty'); }
                        ticketDiv.appendChild(cell);
                    }
                }
                container.appendChild(ticketDiv);
            }
            highlightMyNumbersOnBoard();
        }

        setupFullBoard(); generateHostTicket();
    </script>
</body>
</html>