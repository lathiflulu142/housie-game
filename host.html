<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Housie - Host</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div>
            <h1>üé§ Housie</h1>
            <div class="room-badge">Room Code: <span id="room-code-display">----</span></div>
            <div class="player-count-badge">üë• Players: <span id="player-count-display">0</span></div>
        </div>
        <div class="header-actions">
            <button class="share-btn" onclick="openInviteModal()">üì≤ Invite</button>
            <button id="show-board-btn" onclick="openModal()">üî¢ Board</button>
            <button id="reset-btn" onclick="openResetModal()">üîÑ Reset</button>
        </div>
    </header>

    <main>
        <div class="draw-section">
            <div id="current-number">Go!</div>
            <button id="draw-btn" onclick="drawNumber()">Draw Number</button>
        </div>

        <div class="leaderboard" id="leaderboard-box" style="display: none;">
            <h3>üèÜ Live Winners</h3>
            <ul id="winners-list"></ul>
        </div>

        <div class="ticket-container">
            <h2>My Ticket</h2>
            <div id="host-ticket" class="ticket-grid"></div>
        </div>

        <div class="claims-container" id="claims-box">
            <button id="btn-jaldi" class="claim-btn" onclick="claimPrize('jaldi', 'Jaldi 5')">Jaldi 5</button>
            <button id="btn-top" class="claim-btn" onclick="claimPrize('top', 'Top Line')">Top Line</button>
            <button id="btn-mid" class="claim-btn" onclick="claimPrize('mid', 'Middle Line')">Mid Line</button>
            <button id="btn-bot" class="claim-btn" onclick="claimPrize('bot', 'Bottom Line')">Bot Line</button>
            <button id="btn-full" class="claim-btn full-house" onclick="claimPrize('full', 'Full House')">üéâ FULL HOUSE üéâ</button>
        </div>

        <div class="host-player-list">
            <h2>Live Players</h2>
            <ul id="active-players"></ul>
        </div>
    </main>

    <div id="board-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>Called Numbers</h2>
            <div id="full-board" class="board-grid"></div>
        </div>
    </div>

    <div id="invite-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeInviteModal()">&times;</span>
            <h2>Invite Players</h2>
            <p>Scan to auto-join Room:</p>
            <div id="invite-code-display">----</div>
            <img id="qr-code-img" src="" alt="QR Code" width="180">
            <div class="action-buttons">
                <button class="action-btn btn-blue" onclick="executeShare()">üí¨ Share Link via WhatsApp</button>
            </div>
        </div>
    </div>

    <div id="reset-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeResetModal()">&times;</span>
            <h2>Game Options</h2>
            <p>What would you like to do?</p>
            <div class="action-buttons">
                <button class="action-btn btn-blue" onclick="resetGame()">üîÑ Next Round (Keep Players)</button>
                <button class="action-btn btn-red" onclick="destroyRoom()">üõë End Party (Kick All & New Room)</button>
            </div>
        </div>
    </div>

    <audio id="sound-pop" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" preload="auto"></audio>
    <audio id="sound-win" src="https://actions.google.com/sounds/v1/crowds/party_horn.ogg" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // ==========================================
        // üö® PASTE YOUR REAL FIREBASE KEYS HERE üö®
        // ==========================================
        const firebaseConfig = {
    apiKey: "AIzaSyBaQyf99P3TEp34hhvPZqqPeQ9VCLSQ3N0",
    authDomain: "housieapp-3dc3e.firebaseapp.com",
    databaseURL: "https://housieapp-3dc3e-default-rtdb.firebaseio.com",
    projectId: "housieapp-3dc3e",
    storageBucket: "housieapp-3dc3e.firebasestorage.app",
    messagingSenderId: "709288045803",
    appId: "1:709288045803:web:6505478d4588fec2aae2ae",
    measurementId: "G-6SBEGQB7BE"
  };
        // ==========================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const myPlayerName = "Host üé§";
        const currentNumberDisplay = document.getElementById('current-number');

        let hostState = JSON.parse(localStorage.getItem('housie_host'));
        
        function generateRoomCode() {
            let code = '';
            for (let i = 0; i < 4; i++) code += '0123456789'.charAt(Math.floor(Math.random() * 10));
            return code;
        }

        const myRoomCode = hostState ? hostState.myRoomCode : generateRoomCode();
        let numberBag = hostState ? hostState.numberBag : Array.from({length: 90}, (_, i) => i + 1);
        let myTicketNumbers = hostState ? hostState.myTicketNumbers : null;
        let myMarkedNumbers = hostState ? hostState.myMarkedNumbers : [];
        let currentDrawn = hostState ? hostState.currentDrawn : "Go!";

        document.getElementById('room-code-display').innerText = myRoomCode;
        currentNumberDisplay.innerText = currentDrawn;
        if(currentDrawn !== "Go!") currentNumberDisplay.style.fontSize = "60px";

        function saveHost() {
            localStorage.setItem('housie_host', JSON.stringify({
                myRoomCode, numberBag, myTicketNumbers, myMarkedNumbers, currentDrawn
            }));
        }

        const roomRef = db.ref('rooms/' + myRoomCode);
        
        if (!hostState) {
            roomRef.child('latestNumber').set("Ready");
            roomRef.child('resetTrigger').set(Date.now());
            roomRef.child('claims').remove(); 
            roomRef.child('calledNumbers').remove();
            saveHost();
        }

        // --- NEW: MODAL LOGIC & QR CODE ---
        const boardModal = document.getElementById('board-modal');
        const inviteModal = document.getElementById('invite-modal');
        const resetModal = document.getElementById('reset-modal');

        function openModal() { boardModal.style.display = "flex"; }
        function closeModal() { boardModal.style.display = "none"; }
        function openResetModal() { resetModal.style.display = "flex"; }
        function closeResetModal() { resetModal.style.display = "none"; }

        function openInviteModal() {
            // Generates a magic link with the room code attached!
            const magicLink = window.location.href.replace("host.html", "player.html") + "?room=" + myRoomCode;
            document.getElementById('invite-code-display').innerText = myRoomCode;
            document.getElementById('qr-code-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(magicLink)}`;
            inviteModal.style.display = "flex";
        }
        function closeInviteModal() { inviteModal.style.display = "none"; }

        function executeShare() {
            const magicLink = window.location.href.replace("host.html", "player.html") + "?room=" + myRoomCode;
            const text = `üéâ Join my Housie Party! \nRoom Code: *${myRoomCode}*\nClick here to play: ${magicLink}`;
            if (navigator.share) { navigator.share({ title: 'Housie Party', text: text });
            } else { navigator.clipboard.writeText(text); alert("Invite link copied!"); }
        }

        window.onclick = function(event) { 
            if (event.target == boardModal) closeModal(); 
            if (event.target == inviteModal) closeInviteModal();
            if (event.target == resetModal) closeResetModal();
        }

        roomRef.child('players').on('value', (snapshot) => {
            const players = snapshot.val() || {};
            document.getElementById('player-count-display').innerText = Object.keys(players).length;
            const playerList = document.getElementById('active-players');
            playerList.innerHTML = ''; 
            for (let playerId in players) {
                let li = document.createElement('li');
                li.className = 'player-item';
                li.innerHTML = `<span>${players[playerId].name}</span> <button class="kick-btn" onclick="kickPlayer('${playerId}')">Kick</button>`;
                playerList.appendChild(li);
            }
        });

        function kickPlayer(playerId) {
            if(confirm("Remove this player from the game?")) roomRef.child('players/' + playerId).remove();
        }

        roomRef.child('calledNumbers').on('value', (snapshot) => {
            const called = snapshot.val() || {};
            document.querySelectorAll('.board-cell').forEach(c => c.classList.remove('called'));
            for(let num in called) {
                let cell = document.getElementById(`board-num-${num}`);
                if(cell) cell.classList.add('called');
            }
        });

        let knownClaims = {};
        roomRef.child('claims').on('value', (snapshot) => {
            const claims = snapshot.val() || {};
            const leaderboard = document.getElementById('winners-list');
            const leaderboardBox = document.getElementById('leaderboard-box');
            leaderboard.innerHTML = '';
            let hasWinners = false;

            const prizeList = ['jaldi', 'top', 'mid', 'bot', 'full'];
            prizeList.forEach(id => {
                const btn = document.getElementById('btn-' + id);
                if (btn) btn.style.display = claims[id] ? 'none' : 'inline-block';
            });

            for(let prizeId in claims) {
                hasWinners = true;
                if(!knownClaims[prizeId]) {
                    document.getElementById('sound-win').play().catch(()=>{}); 
                    knownClaims[prizeId] = true;
                }
                let li = document.createElement('li');
                li.innerHTML = `<span>üéä ${claims[prizeId].prizeName}</span> <span class="winner-name">${claims[prizeId].winner}</span>`;
                leaderboard.appendChild(li);
            }
            leaderboardBox.style.display = hasWinners ? "block" : "none";
            for(let prizeId in knownClaims) { if(!claims[prizeId]) delete knownClaims[prizeId]; }
        });

        function claimPrize(prizeId, prizeName) {
            let isValid = false;
            const markedCells = document.querySelectorAll('#host-ticket .cell.marked');
            if(prizeId === 'jaldi') isValid = markedCells.length >= 5;
            if(prizeId === 'top') isValid = document.querySelectorAll('#host-ticket .cell.row-0.marked').length === 5;
            if(prizeId === 'mid') isValid = document.querySelectorAll('#host-ticket .cell.row-1.marked').length === 5;
            if(prizeId === 'bot') isValid = document.querySelectorAll('#host-ticket .cell.row-2.marked').length === 5;
            if(prizeId === 'full') isValid = markedCells.length === 15;

            if(!isValid) { alert(`‚ùå You haven't completed ${prizeName} yet!`); return; }
            if (confirm(`Claim ${prizeName} as the Host?`)) { roomRef.child('claims/' + prizeId).set({ winner: myPlayerName, prizeName: prizeName }); }
        }

        function drawNumber() {
            if (numberBag.length === 0) return;
            const drawnNum = numberBag.splice(Math.floor(Math.random() * numberBag.length), 1)[0];
            
            currentDrawn = drawnNum;
            currentNumberDisplay.innerText = drawnNum;
            currentNumberDisplay.style.fontSize = "60px";

            document.getElementById('sound-pop').play().catch(()=>{}); 
            
            roomRef.child('latestNumber').set(drawnNum);
            roomRef.child('calledNumbers/' + drawnNum).set(true);
            saveHost();
        }

        // --- NEW: THE TWO RESET OPTIONS ---
        function resetGame() {
            if (!confirm("Start next round with the same Room Code and players?")) return; 
            numberBag = Array.from({length: 90}, (_, i) => i + 1);
            myTicketNumbers = null;
            myMarkedNumbers = [];
            currentDrawn = "Go!";
            currentNumberDisplay.innerText = "Go!";
            
            document.querySelectorAll('.board-cell').forEach(cell => cell.classList.remove('called'));
            generateHostTicket();

            roomRef.child('resetTrigger').set(Date.now());
            roomRef.child('latestNumber').set("Ready");
            roomRef.child('calledNumbers').remove();
            roomRef.child('claims').remove(); 
            closeResetModal();
        }

        function destroyRoom() {
            if (!confirm("WARNING: This will kick all players, delete the room, and generate a new code. Proceed?")) return;
            roomRef.remove(); // Deletes the entire room from Firebase!
            localStorage.removeItem('housie_host'); // Wipe Host Memory
            window.location.reload(); // Restarts the app with a brand new code
        }

        function setupFullBoard() {
            const fullBoard = document.getElementById('full-board');
            if (!fullBoard) return;
            fullBoard.innerHTML = ''; 
            for (let i = 1; i <= 90; i++) {
                const cell = document.createElement('div');
                cell.classList.add('board-cell');
                cell.id = `board-num-${i}`;
                cell.innerText = i;
                fullBoard.appendChild(cell);
            }
        }

        function generateHostTicket() {
            const ticketDiv = document.getElementById('host-ticket');
            if (!ticketDiv) return;
            ticketDiv.innerHTML = ''; 

            if (!myTicketNumbers) {
                const ticketLayouts = [
                    [ [1, 0, 1, 1, 0, 1, 0, 1, 0], [0, 1, 0, 1, 0, 1, 0, 1, 1], [1, 0, 1, 0, 1, 0, 1, 0, 1] ],
                    [ [1, 0, 1, 0, 1, 1, 0, 1, 0], [1, 0, 1, 1, 0, 0, 1, 0, 1], [0, 1, 0, 1, 1, 0, 0, 1, 1] ],
                    [ [0, 1, 1, 0, 1, 0, 1, 0, 1], [1, 1, 0, 1, 0, 1, 0, 1, 0], [0, 1, 0, 1, 1, 0, 1, 0, 1] ],
                    [ [0, 1, 0, 1, 1, 0, 1, 0, 1], [1, 1, 0, 1, 0, 1, 0, 1, 0], [0, 1, 1, 0, 1, 0, 1, 1, 0] ],
                    [ [1, 0, 1, 0, 1, 1, 0, 1, 0], [1, 0, 1, 0, 1, 0, 1, 0, 1], [0, 1, 0, 1, 1, 0, 1, 1, 0] ]
                ];
                const ticketPattern = ticketLayouts[Math.floor(Math.random() * ticketLayouts.length)];
                const colRanges = [[1, 9], [10, 19], [20, 29], [30, 39], [40, 49], [50, 59], [60, 69], [70, 79], [80, 90]];
                myTicketNumbers = [[], [], []];

                for (let col = 0; col < 9; col++) {
                    let numbersNeeded = (ticketPattern[0][col] + ticketPattern[1][col] + ticketPattern[2][col]);
                    let possibleNumbers = [];
                    for (let i = colRanges[col][0]; i <= colRanges[col][1]; i++) possibleNumbers.push(i);
                    let selectedForCol = [];
                    for (let n = 0; n < numbersNeeded; n++) selectedForCol.push(possibleNumbers.splice(Math.floor(Math.random() * possibleNumbers.length), 1)[0]);
                    selectedForCol.sort((a, b) => a - b); 
                    let numIndex = 0;
                    for (let row = 0; row < 3; row++) myTicketNumbers[row][col] = (ticketPattern[row][col] === 1) ? selectedForCol[numIndex++] : null;
                }
                saveHost();
            }

            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 9; col++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.classList.add(`row-${row}`);
                    let cellVal = myTicketNumbers[row][col];

                    if (cellVal !== null) {
                        cell.innerText = cellVal;
                        if (myMarkedNumbers.includes(cellVal)) cell.classList.add('marked');

                        cell.addEventListener('pointerdown', function() { 
                            if(document.getElementById(`board-num-${this.innerText}`).classList.contains('called')) {
                                this.classList.toggle('marked'); 
                                if(this.classList.contains('marked')) {
                                    myMarkedNumbers.push(cellVal);
                                } else {
                                    myMarkedNumbers = myMarkedNumbers.filter(n => n !== cellVal);
                                }
                                saveHost();
                            } else {
                                alert(`You haven't drawn number ${this.innerText} yet!`);
                            }
                        });
                    } else {
                        cell.classList.add('empty');
                    }
                    ticketDiv.appendChild(cell);
                }
            }
        }

        setupFullBoard();
        generateHostTicket();
    </script>
</body>
</html>