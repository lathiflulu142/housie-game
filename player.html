<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Housie - Player</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Extra style for the new ticket dropdown */
        #ticket-count-input {
            width: 80%; padding: 15px; font-size: 18px; font-weight: bold;
            text-align: center; border: 2px solid #ccc; border-radius: 10px;
            margin-bottom: 15px; background: white; color: #2c3e50; cursor: pointer;
        }
        .ticket-grid { margin-bottom: 15px; border: 2px solid #a777e3; } /* Separate multiple tickets */
    </style>
</head>
<body>
    <div id="join-screen" class="join-container">
        <div class="join-box">
            <h1>üéüÔ∏è Join Game</h1>
            <p>Enter the code and choose your tickets!</p>
            <input type="text" id="room-code-input" inputmode="numeric" pattern="[0-9]*" placeholder="Code (e.g. 1234)" maxlength="4" autocomplete="off">
            <input type="text" id="player-name-input" placeholder="Your Name" autocomplete="off" maxlength="15">
            
            <select id="ticket-count-input">
                <option value="1">Play 1 Ticket</option>
                <option value="2">Play 2 Tickets</option>
                <option value="3">Play 3 Tickets</option>
            </select>

            <button id="join-btn" onclick="joinRoom(false)">Enter Game</button>
        </div>
    </div>

    <div id="game-screen" style="display: none;">
        <header>
            <div>
                <h1>üéüÔ∏è Player</h1>
                <div class="room-badge">Room: <span id="player-room-display"></span></div>
            </div>
            <div class="header-actions">
                <button id="show-board-btn" onclick="openModal()">üî¢ Called</button>
            </div>
        </header>

        <main>
            <div style="text-align: center; margin-bottom: 15px;">
                <h3 style="color: #6e8efb;">Host Called: <span id="latest-called-num" style="font-size: 26px; color: #ff0844; font-weight: 900;">Waiting...</span></h3>
            </div>

            <div class="leaderboard" id="leaderboard-box" style="display: none;">
                <h3>üèÜ Live Winners</h3>
                <ul id="winners-list"></ul>
            </div>

            <div class="ticket-container">
                <h2>My Tickets</h2>
                <div id="player-ticket-container"></div>
            </div>

            <div class="claims-container" id="claims-box">
                <button id="btn-jaldi" class="claim-btn" onclick="claimPrize('jaldi', 'Jaldi 5')">Jaldi 5</button>
                <button id="btn-top" class="claim-btn" onclick="claimPrize('top', 'Top Line')">Top Line</button>
                <button id="btn-mid" class="claim-btn" onclick="claimPrize('mid', 'Middle Line')">Mid Line</button>
                <button id="btn-bot" class="claim-btn" onclick="claimPrize('bot', 'Bottom Line')">Bot Line</button>
                <button id="btn-full" class="claim-btn full-house" onclick="claimPrize('full', 'Full House')">üéâ FULL HOUSE üéâ</button>
            </div>
        </main>
    </div>

    <div id="board-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>Numbers Called So Far</h2>
            <div id="full-board" class="board-grid"></div>
        </div>
    </div>

    <audio id="sound-pop" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" preload="auto"></audio>
    <audio id="sound-win" src="https://actions.google.com/sounds/v1/crowds/party_horn.ogg" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // ==========================================
        // üö® PASTE YOUR REAL FIREBASE KEYS HERE üö®
        // ==========================================
         const firebaseConfig = {
    apiKey: "AIzaSyBaQyf99P3TEp34hhvPZqqPeQ9VCLSQ3N0",
    authDomain: "housieapp-3dc3e.firebaseapp.com",
    databaseURL: "https://housieapp-3dc3e-default-rtdb.firebaseio.com",
    projectId: "housieapp-3dc3e",
    storageBucket: "housieapp-3dc3e.firebasestorage.app",
    messagingSenderId: "709288045803",
    appId: "1:709288045803:web:6505478d4588fec2aae2ae",
    measurementId: "G-6SBEGQB7BE"
  };
        // ==========================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let currentRoomRef = null; 

        // Auto-Wipe Old Memory format to prevent crashes
        let playerState = JSON.parse(localStorage.getItem('housie_player'));
        if (playerState && playerState.myTicketNumbers && !Array.isArray(playerState.myTicketNumbers[0][0])) {
            localStorage.removeItem('housie_player');
            playerState = null;
        }

        let myRoomCode = "", myPlayerName = "", myPlayerId = "", ticketCount = 1;
        let myTicketNumbers = null, myMarkedNumbers = [];
        let lastResetTime = playerState ? playerState.lastResetTime : 0;

        function savePlayer() {
            localStorage.setItem('housie_player', JSON.stringify({
                myRoomCode, myPlayerName, myPlayerId, myTicketNumbers, myMarkedNumbers, lastResetTime, ticketCount
            }));
        }

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomFromUrl = urlParams.get('room');
            if(roomFromUrl) document.getElementById('room-code-input').value = roomFromUrl;

            if(playerState && playerState.myRoomCode && !roomFromUrl) {
                document.getElementById('room-code-input').value = playerState.myRoomCode;
                document.getElementById('player-name-input').value = playerState.myPlayerName;
                document.getElementById('ticket-count-input').value = playerState.ticketCount || 1;
                
                myRoomCode = playerState.myRoomCode;
                myPlayerName = playerState.myPlayerName;
                myPlayerId = playerState.myPlayerId;
                myTicketNumbers = playerState.myTicketNumbers;
                myMarkedNumbers = playerState.myMarkedNumbers || [];
                ticketCount = playerState.ticketCount || 1;
                
                // Only auto-join if they actually have active tickets stored
                if (myTicketNumbers) joinRoom(true); 
            }
        };

        function joinRoom(isRestore) {
            if(!isRestore) {
                myRoomCode = document.getElementById('room-code-input').value;
                myPlayerName = document.getElementById('player-name-input').value.trim();
                ticketCount = parseInt(document.getElementById('ticket-count-input').value);

                if (myRoomCode.length !== 4 || isNaN(myRoomCode)) { alert("Enter a 4-digit Code."); return; }
                if (myPlayerName === "") { alert("Enter your name!"); return; }
                
                myPlayerId = "player_" + Date.now();
                myTicketNumbers = null; 
                myMarkedNumbers = [];
                lastResetTime = Date.now();
                savePlayer();
            }

            currentRoomRef = db.ref('rooms/' + myRoomCode);
            const myPlayerRef = currentRoomRef.child('players/' + myPlayerId);

            myPlayerRef.set({ name: myPlayerName }); 
            myPlayerRef.onDisconnect().remove(); 

            myPlayerRef.on('value', (snapshot) => {
                if (snapshot.val() === null && document.getElementById('game-screen').style.display === 'block') {
                    alert("The Host has ended the party or removed you from the room.");
                    localStorage.removeItem('housie_player');
                    window.location.href = window.location.pathname; 
                }
            });

            currentRoomRef.child('latestNumber').on('value', (snapshot) => {
                const num = snapshot.val();
                if (num && num !== "Ready") {
                    document.getElementById('latest-called-num').innerText = num;
                    document.getElementById('sound-pop').play().catch(()=>{}); 
                }
            });

            currentRoomRef.child('calledNumbers').on('value', (snapshot) => {
                const called = snapshot.val() || {};
                document.querySelectorAll('.board-cell').forEach(c => c.classList.remove('called'));
                for(let num in called) {
                    let cell = document.getElementById(`board-num-${num}`);
                    if(cell) cell.classList.add('called');
                }
            });

            // --- SMART RESET FOR NEXT ROUND ---
            currentRoomRef.child('resetTrigger').on('value', (snapshot) => {
                const triggerTime = snapshot.val();
                if (triggerTime && triggerTime > lastResetTime) {
                    lastResetTime = triggerTime;
                    myTicketNumbers = null;
                    myMarkedNumbers = [];
                    savePlayer();
                    
                    // Boot them to the menu so they can change their ticket count!
                    document.getElementById('game-screen').style.display = 'none';
                    document.getElementById('join-screen').style.display = 'flex';
                    alert("The Host has started a New Round! Choose your ticket count and jump back in.");
                }
            });

            let knownClaims = {};
            currentRoomRef.child('claims').on('value', (snapshot) => {
                const claims = snapshot.val() || {};
                const leaderboard = document.getElementById('winners-list');
                const leaderboardBox = document.getElementById('leaderboard-box');
                leaderboard.innerHTML = '';
                let hasWinners = false;
                
                const prizeList = ['jaldi', 'top', 'mid', 'bot', 'full'];
                prizeList.forEach(id => {
                    const btn = document.getElementById('btn-' + id);
                    if (btn) btn.style.display = claims[id] ? 'none' : 'inline-block';
                });

                for(let prizeId in claims) {
                    hasWinners = true;
                    if(!knownClaims[prizeId]) {
                        document.getElementById('sound-win').play().catch(()=>{}); 
                        knownClaims[prizeId] = true;
                    }
                    let li = document.createElement('li');
                    li.innerHTML = `<span>üéä ${claims[prizeId].prizeName}</span> <span class="winner-name">${claims[prizeId].winner}</span>`;
                    leaderboard.appendChild(li);
                }
                
                leaderboardBox.style.display = hasWinners ? "block" : "none";
                for(let prizeId in knownClaims) { if(!claims[prizeId]) delete knownClaims[prizeId]; }
            });

            document.getElementById('join-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            document.getElementById('player-room-display').innerText = myRoomCode;

            generatePlayerTicket();
        }

        // --- SMART MULTI-TICKET ANTI-CHEAT ---
        function claimPrize(prizeId, prizeName) {
            let isValid = false;
            
            // Check each ticket individually to see if ONE of them won!
            for (let t = 0; t < myTicketNumbers.length; t++) {
                const ticketDiv = document.getElementById(`ticket-grid-${t}`);
                const markedCells = ticketDiv.querySelectorAll('.cell.marked');
                
                if(prizeId === 'jaldi' && markedCells.length >= 5) isValid = true;
                if(prizeId === 'top' && ticketDiv.querySelectorAll('.cell.row-0.marked').length === 5) isValid = true;
                if(prizeId === 'mid' && ticketDiv.querySelectorAll('.cell.row-1.marked').length === 5) isValid = true;
                if(prizeId === 'bot' && ticketDiv.querySelectorAll('.cell.row-2.marked').length === 5) isValid = true;
                if(prizeId === 'full' && markedCells.length === 15) isValid = true;

                if (isValid) break; // If one ticket wins, they win!
            }

            if(!isValid) { alert(`‚ùå You haven't completed ${prizeName} on any ticket yet!`); return; }
            if (confirm(`Claim ${prizeName}?`)) {
                currentRoomRef.child('claims/' + prizeId).set({ winner: myPlayerName, prizeName: prizeName });
            }
        }

        // --- MULTI-TICKET GENERATOR ---
        function generatePlayerTicket() {
            const container = document.getElementById('player-ticket-container');
            if (!container) return;
            container.innerHTML = ''; 
            
            // Generate New Tickets
            if (!myTicketNumbers) {
                myTicketNumbers = [];
                const ticketLayouts = [
                    [ [1, 0, 1, 1, 0, 1, 0, 1, 0], [0, 1, 0, 1, 0, 1, 0, 1, 1], [1, 0, 1, 0, 1, 0, 1, 0, 1] ],
                    [ [1, 0, 1, 0, 1, 1, 0, 1, 0], [1, 0, 1, 1, 0, 0, 1, 0, 1], [0, 1, 0, 1, 1, 0, 0, 1, 1] ],
                    [ [0, 1, 1, 0, 1, 0, 1, 0, 1], [1, 1, 0, 1, 0, 1, 0, 1, 0], [0, 1, 0, 1, 1, 0, 1, 0, 1] ],
                    [ [0, 1, 0, 1, 1, 0, 1, 0, 1], [1, 1, 0, 1, 0, 1, 0, 1, 0], [0, 1, 1, 0, 1, 0, 1, 1, 0] ],
                    [ [1, 0, 1, 0, 1, 1, 0, 1, 0], [1, 0, 1, 0, 1, 0, 1, 0, 1], [0, 1, 0, 1, 1, 0, 1, 1, 0] ]
                ];

                for (let t = 0; t < ticketCount; t++) {
                    let singleTicket = [[], [], []];
                    const ticketPattern = ticketLayouts[Math.floor(Math.random() * ticketLayouts.length)];
                    const colRanges = [[1, 9], [10, 19], [20, 29], [30, 39], [40, 49], [50, 59], [60, 69], [70, 79], [80, 90]];

                    for (let col = 0; col < 9; col++) {
                        let numbersNeeded = (ticketPattern[0][col] + ticketPattern[1][col] + ticketPattern[2][col]);
                        let possibleNumbers = [];
                        for (let i = colRanges[col][0]; i <= colRanges[col][1]; i++) possibleNumbers.push(i);
                        let selectedForCol = [];
                        
                        for (let n = 0; n < numbersNeeded; n++) {
                            selectedForCol.push(possibleNumbers.splice(Math.floor(Math.random() * possibleNumbers.length), 1)[0]);
                        }
                        
                        selectedForCol.sort((a, b) => a - b); 
                        let numIndex = 0;
                        for (let row = 0; row < 3; row++) {
                            singleTicket[row][col] = (ticketPattern[row][col] === 1) ? selectedForCol[numIndex++] : null;
                        }
                    }
                    myTicketNumbers.push(singleTicket); // Save ticket to array
                }
                savePlayer();
            }

            // Render All Tickets
            for (let t = 0; t < myTicketNumbers.length; t++) {
                const ticketDiv = document.createElement('div');
                ticketDiv.className = 'ticket-grid';
                ticketDiv.id = `ticket-grid-${t}`;
                
                let ticketData = myTicketNumbers[t];

                for (let row = 0; row < 3; row++) {
                    for (let col = 0; col < 9; col++) {
                        const cell = document.createElement('div');
                        cell.classList.add('cell');
                        cell.classList.add(`row-${row}`);
                        let cellVal = ticketData[row][col];

                        if (cellVal !== null) {
                            cell.innerText = cellVal;
                            // Check Global Marks (so if a number is marked, it applies across tickets)
                            if (myMarkedNumbers.includes(cellVal)) cell.classList.add('marked');

                            cell.addEventListener('pointerdown', function() { 
                                if(document.getElementById(`board-num-${this.innerText}`).classList.contains('called')) {
                                    this.classList.toggle('marked'); 
                                    if(this.classList.contains('marked')) {
                                        if(!myMarkedNumbers.includes(cellVal)) myMarkedNumbers.push(cellVal);
                                    } else {
                                        myMarkedNumbers = myMarkedNumbers.filter(n => n !== cellVal);
                                    }
                                    savePlayer();
                                } else {
                                    alert(`Number ${this.innerText} hasn't been called yet!`);
                                }
                            });
                        } else {
                            cell.classList.add('empty');
                        }
                        ticketDiv.appendChild(cell);
                    }
                }
                container.appendChild(ticketDiv);
            }
        }

        function setupFullBoard() {
            const fullBoard = document.getElementById('full-board');
            if (!fullBoard) return;
            fullBoard.innerHTML = ''; 
            for (let i = 1; i <= 90; i++) {
                const cell = document.createElement('div');
                cell.classList.add('board-cell');
                cell.id = `board-num-${i}`;
                cell.innerText = i;
                fullBoard.appendChild(cell);
            }
        }

        const modal = document.getElementById('board-modal');
        function openModal() { modal.style.display = "flex"; }
        function closeModal() { modal.style.display = "none"; }
        window.onclick = function(event) { if (event.target == modal) closeModal(); }

        setupFullBoard();
    </script>
</body>
</html>